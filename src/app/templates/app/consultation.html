{% extends "app/base.html" %}
{% load static %}
{% load custom_filters %}

{% block nav %}
  {% include "app/_consultation_navigation.html" %}
{% endblock nav %}

{% block main %}
  <div class="mt-4 px-4 sm:px-6 lg:px-8">
    <div class="flex flex-wrap justify-between items-center">
      <div class="md:w-1/3 text-center">
        <a href="{% url 'consultation_new' %}" class="text-center p-4 text-sm text-white border border-gray-300 rounded-lg bg-yellow-200 font-semibold hover:bg-yellow-300">新しい相談を作成</a>      </div>
      <div class="md:w-2/3 max-w-md mx-auto">
        <div class="space-y-4">
          {% include "app/_consultation_search_title.html" %}
          {% include "app/_consultation_search_datetime.html" %}
        </div>
      </div>
    </div>

    <h2 class="mt-10 text-2xl font-semibold text-gray-800">相談一覧</h2>
    {% if consultations %}
      {% for consultation in consultations %}
        {% if request.user.id == consultation.user_id %}
          <div class="relative overflow-x-auto">
            <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                  <th scope="col" class="px-6 py-3">相談名</th>
                  <td scope="col" class="px-6 py-3">チャットURL</td>
                  <td scope="col" class="px-6 py-3">書類</td>
                  <td scope="col" class="px-6 py-3">質問項目</td>
                  <td scope="col" class="px-6 py-3">作成日時</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
              </thead>
              <tbody>
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                      <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">{{ consultation.title }}</th>
                      <td class="px-6 py-4">
                        <a href="{% url 'chat' consultation.room_link|extract_last_segment %}" 
                          onclick="navigateToChat('{{ consultation.room_link|extract_last_segment }}')" class="hover:underline">
                            {{ consultation.room_link }}
                        </a>
                      </td>
                      <td class="px-6 py-4">{{ consultation.file }}</td>
                      <td class="px-6 py-4">{{ consultation.checklist }}</td>
                      <td class="px-6 py-4">{{ consultation.created_at }}</td>
                      <td class="px-6 py-4"><a href="{% url "consultation_detail" consultation.id %}">詳細</a></td>
                      <td class="px-6 py-4"><a href="{% url "consultation_edit" consultation.id %}">編集</a></td>
                      <td class="px-6 py-4"><a href="{% url "consultation_edit" consultation.id %}">削除</a></td>
                    </tr>
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="mt-4 text-gray-600">過去の相談がありません。</p>
        {% endif %}
      {% endfor %}
    {% else %}
      <p class="mt-4 text-gray-600">過去の相談がありません。</p>
    {% endif %}
  </div>
  <script>
    function navigateToChat(roomName) {
      const ws = new WebSocket('ws://' + window.location.host + '/ws/consultation/' + roomName + '/');
      window.location.href = '/consultation/' + roomName + '/';
    }
  </script>
{% endblock main %}
